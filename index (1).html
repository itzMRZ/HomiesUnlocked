<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Scheduler Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<!-- Place this in your head section -->
<style>
    .active-selected {
        outline: 2px solid #ff9900;
        cursor: pointer;
    }
</style>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-4">
        <!-- Course Selection Interface -->
        <div class="grid grid-cols-2 gap-4 mb-8">
            <!-- Selection Panel -->
            <div class="space-y-4">
              <input id="search-input" type="text" placeholder="Search courses..." class="bg-gray-800 rounded-lg p-2 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div class="flex space-x-4">
                <div class="flex-1 bg-gray-800 rounded-lg p-2">
                  <h3 class="font-bold text-sm mb-1">Available Courses</h3>
                  <select id="available-courses" multiple class="w-full h-36 bg-gray-700 rounded p-1 text-sm focus:outline-none"></select>
                </div>
                <div class="flex flex-col justify-between h-36 space-y-1">
                  <button id="add-course" class="w-8 h-8 text-xs bg-green-600 rounded hover:bg-green-700 transition-colors flex items-center justify-center">
                      <i class="fas fa-arrow-right"></i>
                  </button>
                  <button id="remove-course" class="w-8 h-8 text-xs bg-red-600 rounded hover:bg-red-700 transition-colors flex items-center justify-center">
                      <i class="fas fa-arrow-left"></i>
                  </button>
                  <button id="drop-all-selected" class="w-8 h-8 text-xs bg-yellow-600 rounded hover:bg-yellow-700 transition-colors flex items-center justify-center">
                      <i class="fas fa-trash"></i>
                  </button>
                </div>
                <div class="flex-1 bg-gray-800 rounded-lg p-2">
                  <h3 class="font-bold text-sm mb-1">Selected Courses</h3>
                  <div id="selected-courses" class="w-full h-36 bg-gray-700 rounded p-1 text-sm overflow-y-auto"></div>
                </div>
              </div>
            </div>
            <!-- Course Information Panel -->
            <div class="bg-gray-800 p-4 rounded-lg">
              <h2 class="text-xl font-bold mb-3">Course Information</h2>
              <div class="space-y-2 text-sm">
                <p><span class="font-semibold">Course:</span> <span id="course-name">-</span></p>
                <p><span class="font-semibold">Faculty:</span> <span id="faculty">-</span></p>
                <p><span class="font-semibold">Section:</span> <span id="section">-</span></p>
                <p><span class="font-semibold">Schedule:</span> <span id="time">-</span></p>
                <p><span class="font-semibold">Seats:</span> <span id="remaining">-</span>/<span id="total-seat">-</span></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Schedule Table -->
        <div class="bg-gray-800 rounded-lg p-3 max-w-[1200px] mx-auto">
            <h2 class="text-2xl font-bold mb-3 text-center">Class Schedule</h2>
            <div class="overflow-x-auto">
                <table class="w-full" id="schedule-table">
                    <thead class="bg-gray-850">
                        <tr>
                            <th class="px-2 py-1 text-left border-r border-gray-700">Time</th>
                            <th class="px-2 py-1 border-r border-gray-700">Sun</th>
                            <th class="px-2 py-1 border-r border-gray-700">Mon</th>
                            <th class="px-2 py-1 border-r border-gray-700">Tue</th>
                            <th class="px-2 py-1 border-r border-gray-700">Wed</th>
                            <th class="px-2 py-1 border-r border-gray-700">Thu</th>
                            <th class="px-2 py-1 border-r border-gray-700">Fri</th>
                            <th class="px-2 py-1">Sat</th>
                        </tr>
                    </thead>
                    <tbody id="schedule" class="divide-y divide-gray-700 text-center">
                        <!-- Schedule rows go here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-6 flex justify-center space-x-4">
            <button id="screenshot-btn" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-camera mr-2"></i>Capture Schedule
            </button>
            <div class="bg-gray-800 px-4 py-2 rounded-lg">
                <span class="text-gray-400 mr-2">Routine ID:</span>
                <span id="copy-routine" class="font-mono text-blue-400 cursor-pointer hover:text-blue-300">
                    Click to copy
                </span>
            </div>
        </div>
    </div>

<script>
// Course Data Management
let allCourses = [];
let selectedCourses = [];
const timeSlots = [
    { start: '8:00 AM', end: '9:20 AM', startMin: 480, endMin: 560 },
    { start: '9:30 AM', end: '10:50 AM', startMin: 570, endMin: 650 },
    { start: '11:00 AM', end: '12:20 PM', startMin: 660, endMin: 740 },
    { start: '12:30 PM', end: '1:50 PM', startMin: 750, endMin: 830 },
    { start: '2:00 PM', end: '3:20 PM', startMin: 840, endMin: 920 },
    { start: '3:30 PM', end: '4:50 PM', startMin: 930, endMin: 1010 },
    { start: '5:00 PM', end: '6:20 PM', startMin: 1020, endMin: 1100 }
];

// Core Functions
async function fetchCourseData() {
    try {
        const response = await fetch("spring-usisdump.json");
        allCourses = await response.json();
        populateAvailableCourses(allCourses);
    } catch (error) {
        console.error('Error loading course data:', error);
    }
}

function populateAvailableCourses(courses) {
    const availableList = document.getElementById('available-courses');
    availableList.innerHTML = '';

    // Sort courses by courseCode and then by sectionName (numeric)
    courses.sort((a, b) => {
        const codeCompare = a.courseCode.localeCompare(b.courseCode);
        if (codeCompare === 0) {
            return parseInt(a.sectionName) - parseInt(b.sectionName);
        }
        return codeCompare;
    });

    courses.forEach(course => {
        const option = new Option(
            `${course.courseCode} - ${course.sectionName} (${course.faculties})`,
            JSON.stringify(course)
        );
        availableList.add(option);
    });
}

function updateCourseInfo(course) {
    document.getElementById('course-name').textContent = course.courseCode;
    document.getElementById('faculty').textContent = course.faculties;
    document.getElementById('section').textContent = course.sectionName;

    let scheduleHTML = "";
    // Process Class schedule with each day on its own line and aligned text
    if (course.preRegSchedule) {
        const classEntries = course.preRegSchedule.trim().split(/(?=Sun|Mon|Tue|Wed|Thu|Fri|Sat)/);
        // First line with label
        scheduleHTML += `<div><span class="inline-block w-20">Class :</span><span>${classEntries[0].trim()}</span></div>`;
        // Subsequent lines get an empty label span for alignment
        for (let i = 1; i < classEntries.length; i++) {
            scheduleHTML += `<div><span class="inline-block w-20"></span><span>${classEntries[i].trim()}</span></div>`;
        }
    }
    // Process Lab schedule in similar way
    if (course.preRegLabSchedule) {
        const labEntries = course.preRegLabSchedule.trim().split(/(?=Sun|Mon|Tue|Wed|Thu|Fri|Sat)/);
        scheduleHTML += `<div><span class="inline-block w-20">Lab :</span><span>${labEntries[0].trim()}</span></div>`;
        for (let i = 1; i < labEntries.length; i++) {
            scheduleHTML += `<div><span class="inline-block w-20"></span><span>${labEntries[i].trim()}</span></div>`;
        }
    }
    document.getElementById('time').innerHTML = scheduleHTML || "-";

    document.getElementById('remaining').textContent = course.consumedSeat;
    document.getElementById('total-seat').textContent = course.capacity;
}


document.getElementById('selected-courses').addEventListener('click', (e) => {
  const entry = e.target.closest('div.bg-gray-700');
  if (entry) {
    const container = document.getElementById('selected-courses');
    // Remove highlight from all entries
    Array.from(container.children).forEach(child => child.classList.remove('active-selected'));
    // Highlight the clicked entry only
    entry.classList.add('active-selected');
    const children = Array.from(container.children);
    const index = children.indexOf(entry);
    if (index !== -1) {
      const course = selectedCourses[index];
      updateCourseInfo(course);
    }
  }
});

// Add event listener to update Course Information on available course selection
document.getElementById('available-courses').addEventListener('change', (e) => {
    const selectedOption = e.target.selectedOptions[0];
    if (selectedOption) {
        const course = JSON.parse(selectedOption.value);
        updateCourseInfo(course);
    }
});


function updateScheduleTable() {
    const scheduleBody = document.getElementById('schedule');
    scheduleBody.innerHTML = '';

    // Create time slots
    timeSlots.forEach(slot => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="p-3 border-b border-gray-700">${slot.start}<br>${slot.end}</td>
            ${Array(7).fill().map((_, i) => `<td class="p-3 border-b border-gray-700 ${i === 6 ? '' : 'border-r'}"></td>`).join('')}
        `;
        scheduleBody.appendChild(row);
    });

    // Conflict detection system
    const courseIntervals = [];
    const conflicts = new Set();

    // Collect all time intervals
    selectedCourses.forEach(course => {
        const processSchedule = (schedule, type) => {
            const day = schedule.day.toLowerCase();
            const start = convertTime(schedule.startTime);
            const end = convertTime(schedule.endTime);

            courseIntervals.push({
                courseId: course.sectionId,
                day,
                start,
                end,
                type,
                course
            });
        };

        course.sectionSchedule.classSchedules.forEach(s => processSchedule(s, 'Class'));
        if (course.labSchedules) course.labSchedules.forEach(s => processSchedule(s, 'Lab'));
    });

    // Detect conflicts
    for (let i = 0; i < courseIntervals.length; i++) {
        for (let j = i + 1; j < courseIntervals.length; j++) {
            const a = courseIntervals[i];
            const b = courseIntervals[j];

            if (a.day === b.day && timeOverlap(a, b)) {
                conflicts.add(a.courseId);
                conflicts.add(b.courseId);
            }
        }
    }

    // Render courses
    courseIntervals.forEach(interval => {
    const dayIndex = ['sunday', 'monday', 'tuesday', 'wednesday',
                      'thursday', 'friday', 'saturday'].indexOf(interval.day);
    if (dayIndex === -1) return;

    const affectedSlots = timeSlots
        .map((slot, index) => ({ index, slot }))
        .filter(({ slot }) => interval.start < slot.endMin && interval.end > slot.startMin);

    affectedSlots.forEach(({ index }) => {
        const cell = scheduleBody.rows[index].cells[dayIndex + 1];
        const isConflict = conflicts.has(interval.courseId);

        const entry = document.createElement('div');
        entry.className = `p-2 rounded text-sm mb-1 ${isConflict ? 'bg-red-900' : interval.type === 'Lab' ? 'bg-purple-800' : 'bg-gray-700'}`;

        entry.innerHTML = `
            <div class="font-semibold">${interval.course.courseCode} [${interval.course.sectionName}] - ${interval.course.faculties}</div>
            <div class="text-gray-300">${interval.type === 'Lab' ? interval.course.labRoomName : interval.course.roomName}</div>
            ${isConflict ? '<div class="text-red-300 mt-1">Conflict</div>' : ''}
        `;
        cell.appendChild(entry);
    });
});
}

// Utility Functions
function convertTime(timeStr) {
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours * 60 + minutes;
}

function timeOverlap(a, b) {
    return a.start < b.end && b.start < a.end;
}

function formatTime(timeString) {
    const [hours, minutes] = timeString.split(':');
    const hour = parseInt(hours);
    const suffix = hour >= 12 ? 'PM' : 'AM';
    const twelveHour = hour % 12 || 12;
    return `${twelveHour}:${minutes} ${suffix}`;
}

// Event Handlers
document.addEventListener('DOMContentLoaded', fetchCourseData);

document.getElementById('add-course').addEventListener('click', () => {
    const availableList = document.getElementById('available-courses');
    const selectedOption = availableList.selectedOptions[0];

    if (selectedOption) {
        const newCourse = JSON.parse(selectedOption.value);

        // Prevent adding more than one section of the same course
        const exists = selectedCourses.some(c => c.courseCode === newCourse.courseCode);
// In the add-course event listener, replace the duplicate check block:
        if (exists) {
            showToast("You cannot add more than one section of the same course. Please drop the other section first!", "warning");
            return;
        }

        selectedCourses.push(newCourse);

        const courseEntry = document.createElement('div');
        courseEntry.className = 'bg-gray-700 p-2 mb-2 rounded text-sm';
        courseEntry.textContent = `${newCourse.courseCode} - ${newCourse.sectionName}`;
        document.getElementById('selected-courses').appendChild(courseEntry);

        availableList.remove(selectedOption.index);
        updateScheduleTable();
    }
});

document.getElementById('remove-course').addEventListener('click', () => {
    const selectedContainer = document.getElementById('selected-courses');
    const entries = Array.from(selectedContainer.children);
    // Loop in reverse to prevent index shifting
    for (let i = entries.length - 1; i >= 0; i--) {
        const entry = entries[i];
        if (entry.classList.contains('active-selected')) {
            // Remove course from selectedCourses array
            const removedCourse = selectedCourses.splice(i, 1)[0];
            // Remove entry from the DOM
            selectedContainer.removeChild(entry);
            // Add the course back as an option in the available courses list
            const option = new Option(
                `${removedCourse.courseCode} - ${removedCourse.sectionName} (${removedCourse.faculties})`,
                JSON.stringify(removedCourse)
            );
            document.getElementById('available-courses').add(option);
        }
    }
    updateScheduleTable();
});

document.getElementById('drop-all-selected').addEventListener('click', () => {
    const availableList = document.getElementById('available-courses');
    const selectedContainer = document.getElementById('selected-courses');
    // Remove all courses from the selected list and add them back
    selectedCourses.forEach(course => {
        const option = new Option(
            `${course.courseCode} - ${course.sectionName} (${course.faculties})`,
            JSON.stringify(course)
        );
        availableList.add(option);
    });
    selectedCourses = [];
    selectedContainer.innerHTML = '';
    updateScheduleTable();
});

document.getElementById('search-input').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = allCourses.filter(course =>
        course.courseCode.toLowerCase().includes(term) ||
        course.sectionName.toLowerCase().includes(term) ||
        course.faculties.toLowerCase().includes(term)
    );
    populateAvailableCourses(filtered);
});

document.getElementById('copy-routine').addEventListener('click', () => {
    const routineData = selectedCourses.map(course => {
        const classTimes = course.sectionSchedule.classSchedules
            .map(s => `${s.day} (${formatTime(s.startTime)}-${formatTime(s.endTime)})`)
            .join(', ');

        const labTimes = course.labSchedules ?
            course.labSchedules
                .map(s => `${s.day} (${formatTime(s.startTime)}-${formatTime(s.endTime)})`)
                .join(', ') : 'N/A';

        return {
            "Course": course.courseCode,
            "section": `Section ${course.sectionName}`,
            "faculty": course.faculties,
            "Class": classTimes,
            "Class_room": course.roomName,
            "Lab": labTimes,
            "Lab_room": course.labRoomName || 'N/A',
            "Exam": `Mid: ${course.sectionSchedule.midExamDetail}, Final: ${course.sectionSchedule.finalExamDetail}`
        };
    });

    navigator.clipboard.writeText(JSON.stringify(routineData, null, 2));
    showToast('Routine copied to clipboard!');
});

document.getElementById('screenshot-btn').addEventListener('click', () => {
    // Clone the schedule table
    const originalTable = document.querySelector("#schedule-table");
    const clonedTable = originalTable.cloneNode(true);

    // Create a hidden container for the cloned table
    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.top = '-10000px';
    container.style.left = '-10000px';
    container.appendChild(clonedTable);
    document.body.appendChild(container);

    // Apply dark mode styles to the cloned table
    clonedTable.style.backgroundColor = '#1f2937';
    clonedTable.style.color = '#ffffff';
    clonedTable.querySelectorAll('td, th').forEach(cell => {
        cell.style.backgroundColor = '#1f2937';
        cell.style.color = '#ffffff';
        cell.style.borderColor = '#374151';
    });

    // Capture the styled clone with html2canvas
    html2canvas(clonedTable).then(canvas => {
        const link = document.createElement('a');
        link.download = 'schedule-screenshot.png';
        link.href = canvas.toDataURL();
        link.click();

        // Show toast after capturing the screenshot
        showToast('Screenshot captured!');

        // Clean up the container
        document.body.removeChild(container);
    });
});

function showToast(message, type = "info") {
    const container = document.getElementById('toastContainer');
    if (!container) return;

    // Define background colors by type
    const bgClasses = {
        success: "bg-green-600",
        warning: "bg-yellow-600",
        error: "bg-red-600",
        info: "bg-blue-600"
    };

    const toast = document.createElement('div');
    toast.className = `${bgClasses[type] || bgClasses.info} text-white px-4 py-2 rounded shadow transition-opacity duration-300 opacity-100`;
    toast.textContent = message;
    container.appendChild(toast);

    // Fade out and remove after 3 seconds
    setTimeout(() => {
        toast.classList.add("opacity-0");
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

</script>
<div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
</body>
</html>