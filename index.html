<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HomiesUnlocked</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    .user-color-sample {
      width: 1rem;
      height: 1rem;
      border-radius: 9999px;
    }
    /* Lightning glitch effect for the tagline */
    @keyframes lightning {
      0% { opacity: 1; filter: brightness(1); }
      20% { opacity: 0.2; filter: brightness(3); }
      40% { opacity: 1; filter: brightness(1); }
      60% { opacity: 0.2; filter: brightness(3); }
      80% { opacity: 1; filter: brightness(1); }
      100% { opacity: 1; filter: brightness(1); }
    }
    #tagline {
      animation: lightning 1s ease-out forwards;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">
  <!-- Header Section -->
  <header class="bg-gray-800 p-6 shadow-lg text-center">
    <h1 class="text-4xl font-bold">HomiesUnlocked</h1>
    <p id="tagline" class="mt-2 text-white">More than a routine....</p>
  </header>

  <!-- Main Container -->
  <div class="container mx-auto p-6">
    <!-- User Input Section -->
    <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-8">
      <!-- Grid with two columns for user cards -->
      <div id="user-inputs" class="grid grid-cols-2 gap-4"></div>
      <div class="flex justify-center mt-4">
        <button id="add-user-btn" class="bg-gray-700 text-gray-300 rounded-full px-4 py-2 hover:bg-gray-600 transition shadow">
          + Add More Users
        </button>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center justify-between mb-8">
      <!-- Left Group: Get Routine ID -->
      <div>
        <button id="get-id-btn" class="flex items-center bg-purple-600 text-white rounded-full px-6 py-2 hover:bg-purple-500 transition shadow">
          <!-- Plus Icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          <span>Get Routine ID</span>
        </button>
      </div>
      <!-- Right Group: Generate and Capture Routine -->
      <div class="flex gap-6">
        <button id="generate-btn" class="flex items-center bg-blue-600 text-white rounded-full px-8 py-2 hover:bg-blue-500 transition shadow">
          <!-- Gear Icon (will spin when generating) -->
          <svg xmlns="http://www.w3.org/2000/svg" id="generate-icon" class="h-5 w-5 mr-2 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33h.09a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51h.09a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82v.09a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z" />
          </svg>
          <span>Generate Routine</span>
        </button>
        <button id="screenshot-btn" class="flex items-center bg-green-600 text-white rounded-full px-8 py-2 hover:bg-green-500 transition shadow">
          <!-- Camera Icon for Screenshot -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h4l2-3h6l2 3h4v13H3V7z" />
            <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
          <span>Capture Routine</span>
          <svg id="screenshot-spinner" class="hidden ml-2 h-5 w-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Routine Table -->
    <div id="combined-routine" class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <div class="text-2xl font-bold text-center mb-4">Combined Routine</div>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-gray-800 text-gray-300 border-collapse">
          <thead>
            <tr>
              <th class="p-2 border border-gray-700">Time</th>
              <th class="p-2 border border-gray-700">Sun</th>
              <th class="p-2 border border-gray-700">Mon</th>
              <th class="p-2 border border-gray-700">Tue</th>
              <th class="p-2 border border-gray-700">Wed</th>
              <th class="p-2 border border-gray-700">Thu</th>
              <th class="p-2 border border-gray-700">Fri</th>
              <th class="p-2 border border-gray-700">Sat</th>
            </tr>
          </thead>
          <tbody id="routine-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    (function() {
      // --- Global Variables and Cached DOM Elements ---
      const userColors = ['#8e44ad', '#27ae60', '#2980b9', '#d35400', '#c0392b',
                          '#f39c12', '#16a085', '#2c3e50', '#7f8c8d', '#e74c3c', '#3498db'];
      const MAX_USERS = 16;
      let userCount = 0;
      const timeSlots = [
        '8:00 AM-9:20 AM', '9:30 AM-10:50 AM',
        '11:00 AM-12:20 PM', '12:30 PM-1:50 PM',
        '2:00 PM-3:20 PM', '3:30 PM-4:50 PM',
        '5:00 PM-6:20 PM'
      ];

      // Cache frequently used elements
      const userInputsContainer = document.getElementById('user-inputs');
      const addUserBtn = document.getElementById('add-user-btn');
      const generateBtn = document.getElementById('generate-btn');
      const generateIcon = document.getElementById('generate-icon');
      const screenshotBtn = document.getElementById('screenshot-btn');
      const screenshotSpinner = document.getElementById('screenshot-spinner');
      const getIdBtn = document.getElementById('get-id-btn');
      const routineTableBody = document.getElementById('routine-table-body');

      // --- Helper Functions ---
      function timeToMinutes(timeStr) {
        timeStr = timeStr.trim().replace(/([AP]M)/i, ' $1').replace(/\s+/g, ' ').toUpperCase();
        const [time, period] = timeStr.split(' ');
        const [hours, minutes] = time.split(':').map(Number);
        let total = hours * 60 + (minutes || 0);
        if (period === 'PM' && hours !== 12) total += 12 * 60;
        if (period === 'AM' && hours === 12) total -= 12 * 60;
        return total;
      }

      function getTextColor(hexColor) {
        const r = parseInt(hexColor.substring(1, 3), 16);
        const g = parseInt(hexColor.substring(3, 5), 16);
        const b = parseInt(hexColor.substring(5, 7), 16);
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        return luminance > 0.5 ? 'black' : 'white';
      }

      function formatDay(dayStr) {
        const dayMap = { SUN: 'Sun', MON: 'Mon', TUE: 'Tue', WED: 'Wed',
                         THU: 'Thu', FRI: 'Fri', SAT: 'Sat' };
        return dayMap[dayStr.toUpperCase().substring(0, 3)] || dayStr;
      }

      function processSession(schedule, session, name, course, color) {
        const [dayPart, timePart] = session.split(' (');
        const day = formatDay(dayPart.trim());
        const rawTime = timePart.replace(')', '').replace(/([AP]M)/gi, ' $1').trim();
        const [startTime, endTime] = rawTime.split('-').map(t => t.trim());
        const sessionStart = timeToMinutes(startTime);
        const sessionEnd = timeToMinutes(endTime);

        timeSlots.forEach(slot => {
          const [slotStartStr, slotEndStr] = slot.split('-');
          const slotStart = timeToMinutes(slotStartStr.trim());
          const slotEnd = timeToMinutes(slotEndStr.trim());
          if (sessionStart <= slotEnd && sessionEnd >= slotStart) {
            schedule[slot][day].push({
              name,
              course: course.Course,
              section: course.section.replace(/Section\s*/i, ''),
              faculty: course.faculty,
              color,
              textColor: getTextColor(color)
            });
          }
        });
      }

      function generateRoutine() {
        // Initialize schedule
        const schedule = {};
        timeSlots.forEach(slot => {
          schedule[slot] = { Sun: [], Mon: [], Tue: [], Wed: [], Thu: [], Fri: [], Sat: [] };
        });

        // Process each user input card
        document.querySelectorAll('#user-inputs > div').forEach((card, idx) => {
          const nameInput = card.querySelector('input');
          const jsonInput = card.querySelector('textarea');
          const color = userColors[idx % userColors.length];
          if (!nameInput.value.trim() || !jsonInput.value.trim()) return;
          try {
            const data = JSON.parse(jsonInput.value.trim());
            data.forEach(course => {
              ['Class', 'Lab'].forEach(type => {
                if (course[type] && course[type] !== 'N/A') {
                  course[type].split(', ').forEach(session => {
                    processSession(schedule, session, nameInput.value.trim(), course, color);
                  });
                }
              });
            });
          } catch (error) {
            console.error('Error processing user input:', error);
          }
        });

        // Rebuild the routine table
        routineTableBody.innerHTML = '';
        timeSlots.forEach(slot => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="p-2 border border-gray-700">${slot}</td>`;
          ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
            const td = document.createElement('td');
            td.className = 'p-2 border border-gray-700 align-top';
            schedule[slot][day].forEach(entry => {
              const div = document.createElement('div');
              // Single-line text with ellipsis
              div.className = 'text-xs mb-1 rounded p-1 whitespace-nowrap overflow-hidden text-ellipsis';
              div.style.backgroundColor = entry.color;
              div.style.color = entry.textColor;
              div.textContent = `${entry.name} - ${entry.course}[${entry.section}] - ${entry.faculty}`;
              td.appendChild(div);
            });
            tr.appendChild(td);
          });
          routineTableBody.appendChild(tr);
        });
      }

      function captureScreenshot() {
  const target = document.querySelector("#combined-routine");
  const rect = target.getBoundingClientRect();
  html2canvas(target, {
    scale: window.devicePixelRatio,
    width: rect.width,
    height: rect.height,
    // Use the element’s top position to avoid issues with scrolling on mobile
    y: rect.top + window.scrollY,
    // Set windowWidth to the actual document width for proper rendering on mobile
    windowWidth: document.documentElement.offsetWidth,
    // Enable CORS if you have external images/fonts
    useCORS: true
  }).then(canvas => {
    const link = document.createElement('a');
    link.download = 'routine-screenshot.png';
    link.href = canvas.toDataURL();
    link.click();
  }).catch(error => console.error('Screenshot capture failed:', error));
      }
      // --- Event Handlers ---
      function handleGenerate() {
        generateBtn.disabled = true;
        generateIcon.classList.add('animate-spin');
        setTimeout(() => {
          generateRoutine();
          generateIcon.classList.remove('animate-spin');
          generateBtn.disabled = false;
        }, 500);
      }

      function handleScreenshot() {
        screenshotBtn.disabled = true;
        screenshotSpinner.classList.remove('hidden');
        captureScreenshot();
        setTimeout(() => {
          screenshotSpinner.classList.add('hidden');
          screenshotBtn.disabled = false;
        }, 1000);
      }

      function handleGetID() {
        // Redirect to the specified URL
        window.location.href = 'https://itzmrz.github.io/Eniamza-PrePrereg-on-Steroids/';
      }

      // Add two new user input cards per click (or one if only one slot remains)
      function addUserInputCards() {
        const remaining = MAX_USERS - userCount;
        const cardsToAdd = remaining >= 2 ? 2 : 1;
        for (let i = 0; i < cardsToAdd; i++) {
          const color = userColors[userCount % userColors.length];
          const userCard = document.createElement('div');
          userCard.className = 'flex items-center bg-gray-700 p-4 rounded-lg space-x-4';
          // Updated input markup: less rounded, equal width for both inputs, less vertical padding, and no resize on the textarea.
          userCard.innerHTML = `
            <div class="flex-1 flex space-x-4">
              <input type="text" class="w-1/2 bg-gray-600 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Name">
              <textarea class="w-1/2 bg-gray-600 rounded-md resize-none px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Routine ID JSON"></textarea>
            </div>
          `;
          // Add color sample to the left
          const colorSample = document.createElement('div');
          colorSample.className = 'user-color-sample';
          colorSample.style.backgroundColor = color;
          userCard.insertBefore(colorSample, userCard.firstChild);

          userInputsContainer.appendChild(userCard);
          userCount++;
        }
      }

      // --- Initialization ---
      document.addEventListener('DOMContentLoaded', () => {
        // Add initial 4 user cards (2 rows of 2 columns)
        addUserInputCards();
        addUserInputCards();
        addUserBtn.addEventListener('click', addUserInputCards);
        generateBtn.addEventListener('click', handleGenerate);
        screenshotBtn.addEventListener('click', handleScreenshot);
        getIdBtn.addEventListener('click', handleGetID);
      });
    })();
  </script>
  <footer class="bg-gray-800 p-4 text-center fixed bottom-0 w-full shadow-lg">
    <a href="https://github.com/itzMRZ"
       class="text-white hover:text-blue-400 transition-colors duration-300 text-sm font-bold flex items-center justify-center gap-2">
        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
            <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/>
        </svg>
        By MRZ
    </a>
</footer>
</body>
</html>
