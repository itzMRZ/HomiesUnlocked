<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HomiesUnlocked</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    .user-color-sample {
      width: 1rem;
      height: 1rem;
      border-radius: 9999px;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">
  <!-- Header Section -->
  <header class="bg-gray-800 p-6 shadow-lg">
    <h1 class="text-4xl font-bold text-center">HomiesUnlocked</h1>
    <p class="text-center text-gray-400 mt-2">More than a routine...</p>
  </header>

  <!-- Main Container -->
  <div class="container mx-auto p-6">
    <!-- User Input Section -->
    <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-8">
      <!-- Grid with two columns for user cards -->
      <div id="user-inputs" class="grid grid-cols-2 gap-4"></div>
      <div class="flex justify-center mt-4">
        <button id="add-user-btn" class="bg-gray-700 text-gray-300 rounded-full px-4 py-2 hover:bg-gray-600 transition shadow">
          + Add More Users
        </button>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-center gap-6 mb-8">
      <button id="generate-btn" class="flex items-center bg-blue-600 text-white rounded-full px-8 py-2 hover:bg-blue-500 transition shadow">
        <!-- Gear Icon (will spin when generating) -->
        <svg xmlns="http://www.w3.org/2000/svg" id="generate-icon" class="h-5 w-5 mr-2 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33h.09a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51h.09a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82v.09a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z" />
        </svg>
        <span>Generate Routine</span>
      </button>
      <button id="screenshot-btn" class="flex items-center bg-green-600 text-white rounded-full px-8 py-2 hover:bg-green-500 transition shadow">
        <!-- Camera Icon for Screenshot -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h4l2-3h6l2 3h4v13H3V7z" />
          <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
        <span>Capture Routine</span>
        <svg id="screenshot-spinner" class="hidden ml-2 h-5 w-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
      </button>
    </div>

    <!-- Routine Table -->
    <div id="combined-routine" class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <div class="text-2xl font-bold text-center mb-4">Combined Routine</div>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-gray-800 text-gray-300 border-collapse">
          <thead>
            <tr>
              <th class="p-2 border border-gray-700">Time</th>
              <th class="p-2 border border-gray-700">Sun</th>
              <th class="p-2 border border-gray-700">Mon</th>
              <th class="p-2 border border-gray-700">Tue</th>
              <th class="p-2 border border-gray-700">Wed</th>
              <th class="p-2 border border-gray-700">Thu</th>
              <th class="p-2 border border-gray-700">Fri</th>
              <th class="p-2 border border-gray-700">Sat</th>
            </tr>
          </thead>
          <tbody id="routine-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    (function() {
      // --- Global Variables and Cached DOM Elements ---
      // Added an extra color (#3498db) for more than 10 users.
      const userColors = ['#8e44ad', '#27ae60', '#2980b9', '#d35400', '#c0392b',
                          '#f39c12', '#16a085', '#2c3e50', '#7f8c8d', '#e74c3c', '#3498db'];
      const MAX_USERS = 16;
      let userCount = 0;
      const timeSlots = [
        '8:00 AM-9:20 AM', '9:30 AM-10:50 AM',
        '11:00 AM-12:20 PM', '12:30 PM-1:50 PM',
        '2:00 PM-3:20 PM', '3:30 PM-4:50 PM',
        '5:00 PM-6:20 PM'
      ];

      // Cache frequently used elements
      const userInputsContainer = document.getElementById('user-inputs');
      const addUserBtn = document.getElementById('add-user-btn');
      const generateBtn = document.getElementById('generate-btn');
      const generateIcon = document.getElementById('generate-icon');
      const screenshotBtn = document.getElementById('screenshot-btn');
      const screenshotSpinner = document.getElementById('screenshot-spinner');
      const routineTableBody = document.getElementById('routine-table-body');

      // --- Helper Functions ---
      function timeToMinutes(timeStr) {
        timeStr = timeStr.trim().replace(/([AP]M)/i, ' $1').replace(/\s+/g, ' ').toUpperCase();
        const [time, period] = timeStr.split(' ');
        const [hours, minutes] = time.split(':').map(Number);
        let total = hours * 60 + (minutes || 0);
        if (period === 'PM' && hours !== 12) total += 12 * 60;
        if (period === 'AM' && hours === 12) total -= 12 * 60;
        return total;
      }

      function getTextColor(hexColor) {
        const r = parseInt(hexColor.substring(1, 3), 16);
        const g = parseInt(hexColor.substring(3, 5), 16);
        const b = parseInt(hexColor.substring(5, 7), 16);
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        return luminance > 0.5 ? 'black' : 'white';
      }

      function formatDay(dayStr) {
        const dayMap = { SUN: 'Sun', MON: 'Mon', TUE: 'Tue', WED: 'Wed',
                         THU: 'Thu', FRI: 'Fri', SAT: 'Sat' };
        return dayMap[dayStr.toUpperCase().substring(0, 3)] || dayStr;
      }

      function processSession(schedule, session, name, course, color) {
        const [dayPart, timePart] = session.split(' (');
        const day = formatDay(dayPart.trim());
        const rawTime = timePart.replace(')', '').replace(/([AP]M)/gi, ' $1').trim();
        const [startTime, endTime] = rawTime.split('-').map(t => t.trim());
        const sessionStart = timeToMinutes(startTime);
        const sessionEnd = timeToMinutes(endTime);

        timeSlots.forEach(slot => {
          const [slotStartStr, slotEndStr] = slot.split('-');
          const slotStart = timeToMinutes(slotStartStr.trim());
          const slotEnd = timeToMinutes(slotEndStr.trim());
          if (sessionStart <= slotEnd && sessionEnd >= slotStart) {
            schedule[slot][day].push({
              name,
              course: course.Course,
              section: course.section.replace(/Section\s*/i, ''),
              faculty: course.faculty,
              color,
              textColor: getTextColor(color)
            });
          }
        });
      }

      function generateRoutine() {
        // Initialize schedule
        const schedule = {};
        timeSlots.forEach(slot => {
          schedule[slot] = { Sun: [], Mon: [], Tue: [], Wed: [], Thu: [], Fri: [], Sat: [] };
        });

        // Process each user input card
        document.querySelectorAll('#user-inputs > div').forEach((card, idx) => {
          const nameInput = card.querySelector('input');
          const jsonInput = card.querySelector('textarea');
          const color = userColors[idx % userColors.length];
          if (!nameInput.value.trim() || !jsonInput.value.trim()) return;
          try {
            const data = JSON.parse(jsonInput.value.trim());
            data.forEach(course => {
              ['Class', 'Lab'].forEach(type => {
                if (course[type] && course[type] !== 'N/A') {
                  course[type].split(', ').forEach(session => {
                    processSession(schedule, session, nameInput.value.trim(), course, color);
                  });
                }
              });
            });
          } catch (error) {
            console.error('Error processing user input:', error);
          }
        });

        // Rebuild the routine table
        routineTableBody.innerHTML = '';
        timeSlots.forEach(slot => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="p-2 border border-gray-700">${slot}</td>`;
          ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
            const td = document.createElement('td');
            td.className = 'p-2 border border-gray-700 align-top';
            schedule[slot][day].forEach(entry => {
              const div = document.createElement('div');
              // Single-line text with ellipsis
              div.className = 'text-xs mb-1 rounded p-1 whitespace-nowrap overflow-hidden text-ellipsis';
              div.style.backgroundColor = entry.color;
              div.style.color = entry.textColor;
              div.textContent = `${entry.name} - ${entry.course}[${entry.section}] - ${entry.faculty}`;
              td.appendChild(div);
            });
            tr.appendChild(td);
          });
          routineTableBody.appendChild(tr);
        });
      }

      function captureScreenshot() {
        html2canvas(document.querySelector("#combined-routine"), {
          scale: window.devicePixelRatio,
          scrollY: -window.scrollY,
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = 'routine-screenshot.png';
          link.href = canvas.toDataURL();
          link.click();
        }).catch(error => console.error('Screenshot capture failed:', error));
      }

      // --- Event Handlers ---
      function handleGenerate() {
        generateBtn.disabled = true;
        generateIcon.classList.add('animate-spin');
        setTimeout(() => {
          generateRoutine();
          generateIcon.classList.remove('animate-spin');
          generateBtn.disabled = false;
        }, 500);
      }

      function handleScreenshot() {
        screenshotBtn.disabled = true;
        screenshotSpinner.classList.remove('hidden');
        captureScreenshot();
        setTimeout(() => {
          screenshotSpinner.classList.add('hidden');
          screenshotBtn.disabled = false;
        }, 1000);
      }

      // Add two new user input cards per click (or one if only one slot remains)
      function addUserInputCards() {
    const remaining = MAX_USERS - userCount;
    const cardsToAdd = remaining >= 2 ? 2 : 1;
    for (let i = 0; i < cardsToAdd; i++) {
        const color = userColors[userCount % userColors.length];
        const userCard = document.createElement('div');
        userCard.className = 'flex items-center bg-gray-700 p-4 rounded-lg space-x-4';
        userCard.innerHTML = `
            <div class="flex-1 flex space-x-4">
                <input type="text" class="w-[40%] bg-gray-600 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Name">
                <input type="text" class="w-[60%] bg-gray-600 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Routine ID JSON">
            </div>
        `;
        // Add color sample to the left
        const colorSample = document.createElement('div');
        colorSample.className = 'user-color-sample';
        colorSample.style.backgroundColor = color;
        userCard.insertBefore(colorSample, userCard.firstChild);

        userInputsContainer.appendChild(userCard);
        userCount++;
    }
}

      // --- Initialization ---
      document.addEventListener('DOMContentLoaded', () => {
        // Add initial 4 user cards (2 rows of 2 columns)
        addUserInputCards();
        addUserInputCards();
        addUserBtn.addEventListener('click', addUserInputCards);
        generateBtn.addEventListener('click', handleGenerate);
        screenshotBtn.addEventListener('click', handleScreenshot);
      });
    })();
  </script>
</body>
</html>
